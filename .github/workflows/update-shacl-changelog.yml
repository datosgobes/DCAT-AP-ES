name: Update SHACL Changelog

on:
  push:
    branches:
      - develop
    paths:
      - 'shacl/**/*.ttl'
  workflow_dispatch:  # Permite ejecución manual

permissions:
  contents: write

jobs:
  update-shacl-changelog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get last changelog commit
        id: last_commit
        run: |
          # Buscar el último commit que actualizó el CHANGELOG
          LAST_COMMIT=$(git log --all --grep="Update SHACL CHANGELOG" --format="%H" -n 1)
          
          # Si no hay commits previos, usar el primer commit de SHACL
          if [ -z "$LAST_COMMIT" ]; then
            LAST_COMMIT=$(git log --all --reverse --format="%H" -- shacl/ | head -1)
          fi
          
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
          echo "Last CHANGELOG update commit: $LAST_COMMIT"

      - name: Generate/Update SHACL CHANGELOG
        run: |
          echo "Updating SHACL CHANGELOG since commit ${{ steps.last_commit.outputs.last_commit }}"
          
          # Verificar si el CHANGELOG existe
          if [ -f "shacl/CHANGELOG.md" ]; then
            # Actualizar desde el último commit registrado
            python3 tools/shacl-changelog-generator/generate_shacl_changelog.py \
              --output shacl/CHANGELOG.md \
              --since "${{ steps.last_commit.outputs.last_commit }}"
          else
            # Crear CHANGELOG completo
            python3 tools/shacl-changelog-generator/generate_shacl_changelog.py \
              --output shacl/CHANGELOG.md
          fi

      - name: Commit and push CHANGELOG
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Update SHACL CHANGELOG [automated]"
          file_pattern: "shacl/CHANGELOG.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      - name: Summary
        run: |
          echo "## SHACL CHANGELOG Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: develop" >> $GITHUB_STEP_SUMMARY
          echo "- **Last CHANGELOG commit**: \`${{ steps.last_commit.outputs.last_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View CHANGELOG](../blob/develop/shacl/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
